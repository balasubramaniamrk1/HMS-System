{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4"><i class="fas fa-cash-register mr-2"></i>Pharmacy POS</h2>

    <div class="row">
        <!-- Product Selection -->
        <div class="col-md-7">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <input type="text" id="tosearch" class="form-control" placeholder="Search medicines...">
                </div>
                <div class="card-body overflow-auto" style="height: 60vh;">
                    <table class="table table-hover" id="medicineTable">
                        <thead>
                            <tr>
                                <th>Medicine</th>
                                <th>Batch</th>
                                <th>Expiry</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="medicineTableBody">
                            <!-- Populated via AJAX -->
                            <tr>
                                <td colspan="6" class="text-center text-muted mt-3">Start typing to search medicines...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Cart Section -->
        <div class="col-md-5">
            <div class="card shadow-sm h-100 border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Current Sale</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    <!-- JS Error Container -->
                    <div id="posError" class="alert alert-danger" style="display: none;"></div>

                    {% if unavailable_items %}
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-circle"></i> Unavailable Prescribed Items:</h6>
                        <ul class="mb-0 pl-3">
                            {% for item in unavailable_items %}
                            <li>{{ item.name }} <small class="text-muted">({{ item.reason }})</small></li>
                            {% endfor %}
                        </ul>
                        <small class="text-muted mt-2 d-block">These items will NOT be included in the invoice.</small>
                    </div>
                    {% endif %}

                    <div class="table-responsive flex-grow-1" style="height: 40vh; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="cartBody">
                                <!-- Cart items go here -->
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-auto border-top pt-3">
                        <div class="d-flex justify-content-between h4">
                            <span>Total:</span>
                            <span id="cartTotal">₹0.00</span>
                        </div>

                        <form method="post" id="posForm">
                            {% csrf_token %}
                            <input type="hidden" name="cart_data" id="cartDataInput">
                            <input type="hidden" name="consultation_id" value="{{ consultation.id|default:'' }}">
                            <input type="hidden" name="admission_id" value="{{ admission.id|default:'' }}">
                            <input type="hidden" name="doctor_id" value="{{ doctor.id|default:'' }}">
                            <input type="hidden" name="patient_name" value="{{ patient_name|default:'' }}">

                            <button type="button" onclick="submitSale()" class="btn btn-success btn-block btn-lg mt-3">
                                <i class="fas fa-check-circle mr-2"></i>Complete Sale
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Print-Only Invoice -->
<div id="printInvoice" style="display: none;">
    <div class="invoice-container">
        <!-- Header -->
        <div class="d-flex border-bottom border-dark pb-2 mb-0">
            <div class="col-6 pl-0">
                <h2 class="font-weight-bold text-maroon">HMS Hospital</h2>
                <p class="mb-0">Ajmer Road, Jaipur, Rajasthan 301202</p>
                <p class="mb-0">Phone: +91 9981278197</p>
                <p class="mb-0">GSTIN: 08AALCR2857A1ZD</p>
                <p class="mb-0">PAN Number: AVHPC9999A</p>
            </div>
            <div class="col-6 pr-0 text-right">
                <h3 class="text-uppercase mb-2">TAX INVOICE</h3>
                <p class="mb-0"><strong>Invoice No:</strong> <span id="printInvoiceId">--</span></p>
                <p class="mb-0"><strong>Invoice Date:</strong> <span id="printDate">--</span></p>
            </div>
        </div>

        <!-- Bill To / Ship To Split -->
        <div class="row mx-0 border-bottom border-dark">
            <div class="col-6 pl-0 border-right border-dark py-2">
                <div class="bg-maroon text-white px-2 py-1 mb-2 font-weight-bold">BILL TO</div>
                <div class="px-2">
                    <strong id="printPatientName" class="d-block h5 mb-1">--</strong>
                    <p class="mb-0 text-muted">123, Patient Address Line 1</p>
                    <p class="mb-0 text-muted">City, State - Pin Code</p>
                    <p class="mb-0">Phone: --</p>
                </div>
            </div>
            <div class="col-6 pr-0 py-2">
                <div class="bg-maroon text-white px-2 py-1 mb-2 font-weight-bold">SHIP TO</div>
                <div class="px-2">
                    <strong id="printDoctorName" class="d-block h5 mb-1">--</strong>
                    <p class="mb-0 text-muted">Doctor / Department Ref</p>
                    <p class="mb-0 text-muted">Hospital Internal Code</p>
                </div>
            </div>
        </div>

        <!-- Items Table -->
        <table class="table table-sm print-table mb-0">
            <thead>
                <tr class="bg-maroon text-white">
                    <th class="py-2 pl-3">Items</th>
                    <th class="py-2 text-right">Quantity</th>
                    <th class="py-2 text-right">Price per Unit</th>
                    <th class="py-2 text-right">Tax per Unit</th>
                    <th class="py-2 text-right pr-3">Amount</th>
                </tr>
            </thead>
            <tbody id="printItemsBody">
                <!-- Populated via JS -->
            </tbody>
            <tfoot class="bg-maroon text-white">
                <tr>
                    <td colspan="4" class="text-right pr-3 py-2 font-weight-bold">Sub Total</td>
                    <td class="text-right pr-3 py-2 font-weight-bold" id="printSubTotal">Rs. 0.00</td>
                </tr>
            </tfoot>
        </table>

        <!-- Footer Section (Bank & Tax Breakdown) -->
        <div class="row mx-0 border border-top-0 border-dark">
            <!-- Left Column: Bank Details -->
            <div class="col-6 border-right border-dark p-3">
                <h6 class="font-weight-bold mb-2">Bank Details</h6>
                <p class="mb-1 small">Account holder: HMS Hospital</p>
                <p class="mb-1 small">Account number: 38028101723</p>
                <p class="mb-1 small">Bank: SBI | Branch: Jaipur</p>
                <p class="mb-1 small">IFSC code: SBIN0002836</p>

                <div class="mt-3">
                    <h6 class="font-weight-bold mb-1">Notes</h6>
                    <p class="small mb-0">1. Goods once sold will not be taken back.</p>
                </div>

                <div class="mt-3">
                    <h6 class="font-weight-bold mb-1">Terms & Conditions</h6>
                    <p class="small mb-0">1. Customer will pay the GST</p>
                    <p class="small mb-0">2. Pay due amount within 15 days</p>
                </div>
            </div>

            <!-- Right Column: Tax Breakdown -->
            <div class="col-6 p-0 d-flex flex-column justify-content-between">
                <div class="p-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-muted">Taxable Amount</span>
                        <span class="font-weight-bold" id="printTaxableAmt">Rs. 0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-muted">CGST @2.5%</span>
                        <span id="printCGST">Rs. 0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-muted">SGST @2.5%</span>
                        <span id="printSGST">Rs. 0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="text-muted">Discount</span>
                        <span>- Rs. 0.00</span>
                    </div>
                </div>

                <div class="border-top border-dark p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="font-weight-bold mb-0">Total Amount</h5>
                        <h5 class="font-weight-bold mb-0" id="printGrandTotal">Rs. 0.00</h5>
                    </div>
                </div>

                <div class="p-3 text-right mt-auto">
                    <br><br>
                    <p class="small mb-0 font-weight-bold">Authorised Signatory For</p>
                    <p class="mb-0 font-weight-bold text-maroon">HMS Hospital</p>
                </div>
            </div>
        </div>

        <div class="p-2 border border-top-0 border-dark">
            <small>Customer Signature</small>
        </div>
    </div>
</div>

<style>
    .text-maroon {
        color: #800000;
    }

    .bg-maroon {
        background-color: #800000 !important;
        color: white;
        -webkit-print-color-adjust: exact;
    }

    @media print {
        body * {
            visibility: hidden;
            height: 0;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        #printInvoice,
        #printInvoice * {
            visibility: visible;
            height: auto;
            overflow: visible;
        }

        #printInvoice {
            display: block !important;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            background: white;
            z-index: 9999;
            font-family: Arial, sans-serif;
        }

        /* Reset containers */
        .container,
        .container-fluid,
        .row,
        .col-md-7,
        .col-md-5,
        aside,
        header,
        footer,
        .card {
            display: none !important;
        }

        /* Border Tweaks */
        .border-dark {
            border-color: #000 !important;
        }

        .print-table th,
        .print-table td {
            border-bottom: 1px solid #ddd;
            padding: 8px 12px;
        }

        .print-table th {
            border-top: none;
        }
    }
</style>

{% endblock %}

{% block extra_js %}
<script>
    let cart = {};

    // Initialize cart from server context if available
    const prefillData = {{ prefill_cart| safe }};
    if (prefillData && prefillData.length > 0) {
        prefillData.forEach(item => {
            cart[item.id] = item;
        });
    }

    // On load
    document.addEventListener('DOMContentLoaded', function () {
        renderCart();
    });

    // AJAX Search
    const searchInput = document.getElementById('tosearch');
    const medicineTableBody = document.getElementById('medicineTableBody');
    let searchTimeout = null;
    let currentFocus = -1;

    searchInput.addEventListener('input', function () {
        const term = this.value.trim();
        currentFocus = -1; // Reset focus on new search

        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            if (term.length < 1) {
                medicineTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted mt-3">Start typing to search medicines...</td></tr>';
                return;
            }

            fetch(`{% url 'pharmacy:pos' %}?term=${encodeURIComponent(term)}`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    medicineTableBody.innerHTML = '';
                    if (data.length === 0) {
                        medicineTableBody.innerHTML = '<tr><td colspan="6" class="text-center">No results found.</td></tr>';
                        return;
                    }

                    // Auto-Add Logic for Barcode Scanning
                    // Only auto-add if exact match AND NOT expired
                    if (data.length === 1 && data[0].is_barcode) {
                        const item = data[0];
                        if (item.is_expired) {
                            // If expired, don't auto-add, but show it in the list (code below will render it red)
                            // show a toast
                            showError(`Barcode scanned: ${item.name} is EXPIRED!`);
                        } else {
                            addToCart(item); // We need to expose addToCart or simulate click
                            searchInput.value = '';
                            return;
                        }
                    }

                    data.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.setAttribute('data-name', item.name); // For keyboard selection reference

                        let actionBtn = '';
                        let rowClass = '';

                        if (item.is_expired) {
                            rowClass = 'table-danger text-muted';
                            actionBtn = `<button class="btn btn-sm btn-secondary" disabled>Expired</button>`;
                        } else {
                            actionBtn = `<button class="btn btn-sm btn-primary add-to-cart-btn" 
                                data-id="${item.id}" data-name="${item.name}" 
                                data-batch="${item.batch}" data-price="${item.price}" 
                                data-max="${item.stock}">Add</button>`;
                        }

                        tr.className = rowClass;
                        tr.innerHTML = `
                        <td><strong>${item.name}</strong><br>
                            <small class="text-muted">${item.generic || ''}</small>
                            ${item.barcode ? `<br><small class="text-info"><i class="fas fa-barcode"></i> ${item.barcode}</small>` : ''}
                        </td>
                        <td>${item.batch}</td>
                        <td>${item.expiry}</td>
                        <td>₹${item.price.toFixed(2)}</td>
                        <td>${item.stock}</td>
                        <td>${actionBtn}</td>
                    `;
                        medicineTableBody.appendChild(tr);
                    });
                });
        }, 300);
    });

    // Helper to simulate add from data object directly
    function addToCart(item) {
        // Logic duplicated from click handler but clean
        const id = item.id.toString();
        if (cart[id]) {
            if (cart[id].quantity < item.stock) {
                cart[id].quantity++;
            } else {
                showError('Max stock reached for this batch!');
            }
        } else {
            cart[id] = {
                id: id,
                name: item.name,
                batch: item.batch,
                price: item.price,
                quantity: 1,
                max: item.stock
            };
        }
        renderCart();
    }

    // Keyboard Navigation for POS
    searchInput.addEventListener('keydown', function (e) {
        let rows = medicineTableBody.getElementsByTagName('tr');
        // Filter out non-result rows (like loading/empty messages) if needed, 
        // but simplest is just check if they have add-btn or data attributes

        if (e.key === 'ArrowDown') {
            currentFocus++;
            addActive(rows);
        } else if (e.key === 'ArrowUp') {
            currentFocus--;
            addActive(rows);
        } else if (e.key === 'Enter' || e.key === 'Tab') {
            if (currentFocus > -1 && rows[currentFocus]) {
                const btn = rows[currentFocus].querySelector('.add-to-cart-btn');
                if (btn) {
                    btn.click();
                    // Optional: Clear search after selection?
                    // searchInput.value = ''; 
                    // medicineTableBody.innerHTML = ...;
                    e.preventDefault();
                }
            }
        }
    });

    function addActive(x) {
        if (!x) return false;
        removeActive(x);
        if (currentFocus >= x.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = (x.length - 1);
        x[currentFocus].classList.add("table-active"); // Bootstrap class for highlighting
        x[currentFocus].scrollIntoView({ block: "nearest" });
    }

    function removeActive(x) {
        for (let i = 0; i < x.length; i++) {
            x[i].classList.remove("table-active");
        }
    }

    // Event Delegation for Add Buttons (since elements are dynamic)
    document.getElementById('medicineTableBody').addEventListener('click', function (e) {
        if (e.target.classList.contains('add-to-cart-btn')) {
            const btn = e.target;
            const id = btn.dataset.id;

            if (cart[id]) {
                if (cart[id].quantity < parseInt(btn.dataset.max)) {
                    cart[id].quantity++;
                } else {
                    showError('Max stock reached for this batch!');
                }
            } else {
                cart[id] = {
                    id: id,
                    name: btn.dataset.name,
                    batch: btn.dataset.batch,
                    price: parseFloat(btn.dataset.price),
                    quantity: 1,
                    max: parseInt(btn.dataset.max)
                };
            }
            renderCart();
        }
    });

    function renderCart() {
        const tbody = document.getElementById('cartBody');
        tbody.innerHTML = '';
        let total = 0;

        for (const [id, item] of Object.entries(cart)) {
            const lineTotal = item.price * item.quantity;
            total += lineTotal;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    ${item.name}<br>
                    <small class="text-muted">${item.batch}</small>
                </td>
                <td>
                    <input type="number" min="1" max="${item.max}" value="${item.quantity}" 
                           class="form-control form-control-sm" style="width: 60px"
                           onchange="updateQty(${id}, this.value)">
                </td>
                <td>₹${item.price}</td>
                <td>₹${lineTotal.toFixed(2)}</td>
                <td><button class="btn btn-sm btn-danger" onclick="removeFromCart(${id})">&times;</button></td>
            `;
            tbody.appendChild(tr);
        }

        document.getElementById('cartTotal').textContent = '₹' + total.toFixed(2);
        updatePrintView();
    }

    function removeFromCart(id) {
        delete cart[id];
        renderCart();
    }

    function updateQty(id, qty) {
        qty = parseInt(qty);
        if (qty > 0 && qty <= cart[id].max) {
            cart[id].quantity = qty;
        } else {
            showError('Invalid quantity or exceeds stock limit.');
            renderCart(); // Reset view
        }
        renderCart();
    }

    function updatePrintView() {
        const tbody = document.getElementById('printItemsBody');
        tbody.innerHTML = '';

        let subTotal = 0;
        let totalTax = 0;

        // Populate Items
        let counter = 1;
        for (const [id, item] of Object.entries(cart)) {
            const qty = item.quantity;
            const price = item.price;
            const lineTotal = price * qty;

            // Tax Logic: 5% Placeholder with Amount Calc
            const taxRate = 0.05; // 5%
            const taxPerUnit = price * taxRate;
            const lineTax = taxPerUnit * qty;

            subTotal += lineTotal;
            totalTax += lineTax;

            const tr = document.createElement('tr');
            // Inline styles to match the new table layout
            const cellStyle = 'border: 1px solid #000; padding: 8px; font-size: 14px;';

            tr.innerHTML = `
                <td style="${cellStyle} text-align: left;">${item.name}</td>
                <td style="${cellStyle} text-align: center;">${qty}</td>
                <td style="${cellStyle} text-align: right;">${price.toFixed(2)}</td>
                <td style="${cellStyle} text-align: right;">
                    <strong>5%</strong><br>
                    <small>(Rs. ${taxPerUnit.toFixed(2)})</small>
                </td>
                <td style="${cellStyle} text-align: right;">${lineTotal.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
            counter++;
        }

        const grandTotal = subTotal + totalTax;

        // Update Footer Totals (using helper to avoid null errors)
        const setText = (id, val) => {
            const el = document.getElementById(id);
            if (el) el.textContent = 'Rs. ' + val.toFixed(2);
        };

        setText('printSubTotal', subTotal);
        setText('printTaxableAmt', subTotal);

        // Split Tax into CGST/SGST (5% total => 2.5% each)
        const halfTax = totalTax / 2;
        setText('printCGST', halfTax);
        setText('printSGST', halfTax);
        setText('printGrandTotal', grandTotal);

        // Update Patient Info
        const pNameInput = document.querySelector('input[name="patient_name"]');
        const pName = pNameInput ? (pNameInput.value || 'Walk-in Patient') : 'Walk-in Patient';

        const nameEl = document.getElementById('printPatientName');
        if (nameEl) nameEl.textContent = pName;

        // Date
        const dateEl = document.getElementById('printDate');
        if (dateEl) {
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            dateEl.textContent = dateStr;
        }
    }

    function showError(message) {
        const errorDiv = document.getElementById('posError');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }

    function submitSale() {
        if (Object.keys(cart).length === 0) {
            showError('Cart is empty! Cannot complete sale.');
            return;
        }

        // Convert cart object to array
        const cartArray = Object.values(cart).map(item => ({
            batch_id: item.id,
            quantity: item.quantity
        }));

        document.getElementById('cartDataInput').value = JSON.stringify(cartArray);
        document.getElementById('posForm').submit();
    }
</script>
{% endblock %}