{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-11">
            <div class="card border-0 shadow">
                <div class="card-header bg-success text-white py-3">
                    <h5 class="mb-0 font-weight-bold"><i class="fas fa-box-open mr-2"></i>Stock Entry (GRN)</h5>
                </div>
                <div class="card-body p-4">
                    {% if po %}
                    <div class="alert alert-info">
                        Receiving items against <strong>PO #{{ po.id }}</strong>
                        for vendor <strong>{{ po.vendor.name }}</strong>
                    </div>
                    {% endif %}

                    <form method="POST" id="grnForm">
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label class="font-weight-bold">Vendor</label>
                                {% if po %}
                                <input type="text" class="form-control" value="{{ po.vendor.name }}" readonly>
                                <input type="hidden" name="vendor" value="{{ po.vendor.id }}">
                                {% else %}
                                <select name="vendor" class="form-control" required>
                                    {% for v in vendors %}
                                    <option value="{{ v.id }}">{{ v.name }}</option>
                                    {% endfor %}
                                </select>
                                {% endif %}
                            </div>
                            <div class="form-group col-md-4">
                                <label class="font-weight-bold">Vendor Invoice No.</label>
                                <input type="text" name="invoice_no" class="form-control" required>
                            </div>
                            <div class="form-group col-md-4">
                                <label class="font-weight-bold">Invoice Date</label>
                                <input type="date" name="invoice_date" class="form-control" required>
                            </div>
                        </div>

                        <h6 class="font-weight-bold mt-4 mb-3 border-bottom pb-2">Received Items</h6>
                        <table class="table table-bordered text-center table-sm">
                            <thead class="bg-light">
                                <tr>
                                    <th width="30%">Medicine</th>
                                    <th width="15%">Batch No.</th>
                                    <th width="15%">Expiry</th>
                                    <th width="10%">Qty</th>
                                    <th width="10%">Buy Price</th>
                                    <th width="10%">MRP</th>
                                    <th width="5%"></th>
                                </tr>
                            </thead>
                            <tbody id="stockBody">
                                {% if po and po.items.all %}
                                {% for item in po.items.all %}
                                <tr>
                                    <td>
                                        <input type="text" class="form-control form-control-sm"
                                            value="{{ item.medicine.name }}" readonly>
                                        <input type="hidden" class="item-med-id" value="{{ item.medicine.id }}">
                                    </td>
                                    <td><input type="text" class="form-control form-control-sm item-batch" required
                                            placeholder="Batch 123"></td>
                                    <td><input type="date" class="form-control form-control-sm item-expiry" required>
                                    </td>
                                    <td><input type="number" class="form-control form-control-sm item-qty"
                                            value="{{ item.quantity_requested }}" required></td>
                                    <td><input type="number" step="0.01" class="form-control form-control-sm item-buy"
                                            value="{{ item.unit_price_expected }}" required></td>
                                    <td><input type="number" step="0.01" class="form-control form-control-sm item-sell"
                                            required placeholder="MRP"></td>
                                    <td><button type="button" class="btn btn-sm btn-danger"
                                            onclick="this.closest('tr').remove()"><i class="fas fa-times"></i></button>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% endif %}
                            </tbody>
                        </table>

                        {% if not po %}
                        <div class="text-right mb-4">
                            <button type="button" class="btn btn-sm btn-info" onclick="addStockRow()">
                                <i class="fas fa-plus"></i> Add Line
                            </button>
                        </div>
                        {% endif %}

                        <input type="hidden" name="items_json" id="itemsJson">

                        <div class="d-flex justify-content-end">
                            <a href="{% url 'pharmacy:purchase_order_list' %}" class="btn btn-secondary mr-2">Cancel</a>
                            <button type="submit" class="btn btn-success px-5 font-weight-bold"
                                onclick="prepareSubmit(event)">Save Stock</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function addStockRow() {
        const row = `
    <tr>
        <td>
            <select class="form-control form-control-sm item-med-id" required>
                <option value="">Select Medicine...</option>
                {% for med in medicines %}
                <option value="{{ med.id }}">{{ med.name }}</option>
                {% endfor %}
            </select>
        </td>
        <td><input type="text" class="form-control form-control-sm item-batch" required></td>
        <td><input type="date" class="form-control form-control-sm item-expiry" required></td>
        <td><input type="number" class="form-control form-control-sm item-qty" value="1" required></td>
        <td><input type="number" step="0.01" class="form-control form-control-sm item-buy" value="0.00" required></td>
        <td><input type="number" step="0.01" class="form-control form-control-sm item-sell" value="0.00" required></td>
        <td><button type="button" class="btn btn-sm btn-danger" onclick="this.closest('tr').remove()"><i class="fas fa-times"></i></button></td>
    </tr>
    `;
        document.getElementById('stockBody').insertAdjacentHTML('beforeend', row);
    }

    // Initialize logic via hidden input to avoid JS syntax errors with Django tags
    // We check if the input exists (it's only rendered if po exists? No, logic is complex)
    // Use a simpler approach:
</script>

<!-- Hidden input to pass generic data to JS if needed, but for hasPO we can use a simpler conditional script execution -->
{% if not po %}
<script>
    document.addEventListener('DOMContentLoaded', addStockRow);
</script>
{% endif %}

<script>
    function prepareSubmit(e) {
        const rows = document.querySelectorAll('#stockBody tr');
        let items = [];

        rows.forEach(row => {
            const medId = row.querySelector('.item-med-id').value; // Might be input or select

            if (medId) {
                items.push({
                    medicine_id: medId,
                    batch_no: row.querySelector('.item-batch').value,
                    expiry: row.querySelector('.item-expiry').value,
                    quantity: row.querySelector('.item-qty').value,
                    buy_price: row.querySelector('.item-buy').value,
                    sell_price: row.querySelector('.item-sell').value
                });
            }
        });

        if (items.length === 0) {
            e.preventDefault();
            alert('Please add at least one item.');
            return;
        }

        document.getElementById('itemsJson').value = JSON.stringify(items);
    }
</script>
{% endblock %}