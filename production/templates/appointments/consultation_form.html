{% extends 'base.html' %}
{% load static %}

{% block title %}Consultation - {{ appointment.name }}{% endblock %}

{% block content %}
<section class="page-header">
    <div class="container">
        <h1>Patient Consultation</h1>
        <p>{{ appointment.name }} - {{ appointment.preferred_date }}</p>
    </div>
</section>

<section class="container section-padding" style="max-width: 1800px; margin: 0 auto;">
    <div class="card" style="padding: 30px;">
        <div class="patient-info" style="background: #f9f9f9; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
            <h3>Patient Details</h3>
            <p><strong>Name:</strong> {{ appointment.name }}</p>
            <p><strong>Age/Gender:</strong> N/A (Field to be added)</p>
            <p><strong>Complaint:</strong> {{ appointment.message }}</p>
        </div>

        <form method="post">
            {% csrf_token %}

            {% if is_read_only %}
            <div class="alert alert-warning shadow-sm border-left-warning">
                <h4 class="alert-heading"><i class="fas fa-eye"></i> View Only Mode</h4>
                <p class="mb-0">You are viewing this as an Administrator. Only Doctors can prescribe medicines or
                    complete consultations.</p>
            </div>
            {% endif %}

            <div class="form-group">
                <label>Diagnosis / Clinical Findings</label>
                <textarea name="diagnosis" class="form-control" rows="5" required {{ is_read_only|yesno:"disabled,"
                    }}></textarea>
            </div>

            <div class="form-group">
                <label>Prescription (Rx)</label>
                <div class="table-responsive">
                    <table class="table table-bordered" id="medicineTable">
                        <thead>
                            <tr style="background: #f1f2f6;">
                                <th style="width: 35%;">Medicine Name</th>
                                <th style="width: 20%;">Dosage (e.g. 1-0-1)</th>
                                <th style="width: 20%;">Duration (e.g. 5 days)</th>
                                <th style="width: 20%;">Instruction (After Food)</th>
                                <th style="width: 5%;"></th>
                            </tr>
                        </thead>
                        <tbody id="medicineTableBody">
                            <tr>
                                <td>
                                    <div class="medicine-wrapper">
                                        <input type="text" name="medicine_name[]" class="form-control medicine-search"
                                            required placeholder="Start typing..." autocomplete="off" {{
                                            is_read_only|yesno:"disabled," }}>
                                        <ul class="suggestions-list" style="display: none;"></ul>
                                    </div>
                                </td>
                                <td>
                                    <input type="text" name="dosage[]" class="form-control dosage-input" required
                                        placeholder="1-0-1" {{ is_read_only|yesno:"disabled," }}>
                                    <small class="text-danger dosage-error" style="display: none;">High dosage detected
                                        (3+ digits). Verify.</small>
                                </td>
                                <td><input type="text" name="duration[]" class="form-control" required
                                        placeholder="3 days" {{ is_read_only|yesno:"disabled," }}></td>
                                <td><input type="text" name="instruction[]" class="form-control"
                                        placeholder="After food" {{ is_read_only|yesno:"disabled," }}></td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-sm btn-danger remove-row" disabled>
                                        <i class="fas fa-times"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                {% if not is_read_only %}
                <button type="button" class="btn btn-secondary btn-sm" id="addMedicineBtn">
                    <i class="fas fa-plus"></i> Add Medicine
                </button>
                {% endif %}
            </div>

            <script>

                document.addEventListener('DOMContentLoaded', function () {
                    // Initial setup for existing rows
                    document.querySelectorAll('.medicine-search').forEach(setupAutocomplete);
                    document.querySelectorAll('.dosage-input').forEach(setupDosageValidation);

                    // Add Medicine Button Logic
                    document.getElementById('addMedicineBtn').addEventListener('click', function () {
                        const tbody = document.getElementById('medicineTableBody');
                        const newRow = document.createElement('tr');
                        newRow.innerHTML = `
                            <td>
                                <div class="medicine-wrapper">
                                    <input type="text" name="medicine_name[]" class="form-control medicine-search" required placeholder="Start typing..." autocomplete="off">
                                    <ul class="suggestions-list" style="display: none;"></ul>
                                </div>
                            </td>
                            <td>
                                <input type="text" name="dosage[]" class="form-control dosage-input" required placeholder="1-0-1">
                                <small class="text-danger dosage-error" style="display: none;">High dosage detected (3+ digits). Verify.</small>
                            </td>
                            <td><input type="text" name="duration[]" class="form-control" required placeholder="3 days"></td>
                            <td><input type="text" name="instruction[]" class="form-control" placeholder="After food"></td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-danger remove-row" onclick="this.closest('tr').remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                            `;
                        tbody.appendChild(newRow);

                        // Apply handlers to new inputs
                        setupAutocomplete(newRow.querySelector('.medicine-search'));
                        setupDosageValidation(newRow.querySelector('.dosage-input'));
                    });
                });

                // --- Autocomplete Function ---
                function setupAutocomplete(input) {
                    let timeout = null;
                    const list = input.nextElementSibling; // The ul.suggestions-list
                    let currentFocus = -1;

                    input.addEventListener('input', function () {
                        const term = this.value.trim();
                        currentFocus = -1;

                        // Hide if empty
                        if (term.length < 1) {
                            list.style.display = 'none';
                            return;
                        }

                        clearTimeout(timeout);
                        timeout = setTimeout(() => {
                            fetch(`{% url 'pharmacy:pos' %}?term=${encodeURIComponent(term)}`, {
                                headers: { 'X-Requested-With': 'XMLHttpRequest' }
                            })
                                .then(response => response.json())
                                .then(data => {
                                    list.innerHTML = '';
                                    if (data.length === 0) {
                                        list.style.display = 'none';
                                        return;
                                    }

                                    data.forEach(item => {
                                        const li = document.createElement('li');
                                        li.innerHTML = `<strong>${item.name}</strong><small>${item.generic || ''} (Stock: ${item.stock})</small>`;
                                        // Click Selection
                                        li.addEventListener('click', function () {
                                            selectItem(input, list, item.name);
                                        });
                                        list.appendChild(li);
                                    });
                                    list.style.display = 'block';
                                });
                        }, 300);
                    });

                    // Keyboard Navigation
                    input.addEventListener('keydown', function (e) {
                        let items = list.getElementsByTagName('li');
                        if (e.key === 'ArrowDown') {
                            currentFocus++;
                            addActive(items);
                        } else if (e.key === 'ArrowUp') {
                            currentFocus--;
                            addActive(items);
                        } else if (e.key === 'Enter' || e.key === 'Tab') {
                            if (currentFocus > -1) {
                                if (items) items[currentFocus].click();
                                if (e.key === 'Enter') e.preventDefault(); // Prevent form submit on Enter
                            }
                        }
                    });

                    function addActive(x) {
                        if (!x) return false;
                        removeActive(x);
                        if (currentFocus >= x.length) currentFocus = 0;
                        if (currentFocus < 0) currentFocus = (x.length - 1);
                        x[currentFocus].classList.add("active");
                        x[currentFocus].scrollIntoView({ block: "nearest" });
                    }

                    function removeActive(x) {
                        for (let i = 0; i < x.length; i++) {
                            x[i].classList.remove("active");
                        }
                    }

                    function selectItem(inp, lst, val) {
                        inp.value = val;
                        lst.style.display = 'none';
                        // Refocus to next input? Optional but good UX
                        // inp.closest('td').nextElementSibling.querySelector('input').focus();
                    }

                    // Hide on click outside
                    document.addEventListener('click', function (e) {
                        if (!input.contains(e.target) && !list.contains(e.target)) {
                            list.style.display = 'none';
                        }
                    });
                }

                // --- Dosage Validation Function ---
                function setupDosageValidation(input) {
                    input.addEventListener('input', function () {
                        const val = this.value.trim();
                        const errorMsg = this.nextElementSibling; // The small.text-danger

                        // Regex to catch high numbers in patterns (e.g., 100-100-100)
                        if (/\d{3,}/.test(val)) {
                            this.style.borderColor = "#e74c3c";
                            if (errorMsg) errorMsg.style.display = 'block';
                        } else {
                            this.style.borderColor = "#cbd5e0";
                            if (errorMsg) errorMsg.style.display = 'none';
                        }
                    });
                }
            </script>

            <div class="form-group">
                <label>Doctor's Private Notes</label>
                <textarea name="notes" class="form-control" rows="3" required {{ is_read_only|yesno:"disabled,"
                    }}></textarea>
            </div>

            <div class="form-group">
                <label>Comments for Report</label>
                <textarea name="doctor_comments" class="form-control" rows="3"
                    placeholder="Comments visible to patient..." {{ is_read_only|yesno:"disabled," }}></textarea>
            </div>

            {% if not is_read_only %}
            <button type="submit" class="btn-primary btn-block">Complete Consultation</button>
            {% else %}
            <button type="button" class="btn btn-secondary btn-block" disabled>Submission Disabled (Admin View)</button>
            {% endif %}
        </form>
    </div>
</section>
{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #f4f7f6;
        font-family: 'Inter', sans-serif;
    }

    .page-header {
        background: linear-gradient(135deg, #0061f2 0%, #00ba94 100%);
        color: white;
        padding: 40px 0;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .page-header h1 {
        margin: 0;
        font-weight: 700;
        font-size: 2.5rem;
    }

    .page-header p {
        opacity: 0.9;
        font-size: 1.1rem;
    }

    .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        border: 1px solid #e0e0e0;
        padding: 40px !important;
    }

    .patient-info {
        background: #eef2f5 !important;
        border-left: 5px solid #0061f2;
        padding: 20px !important;
        border-radius: 8px;
        margin-bottom: 30px !important;
    }

    .patient-info h3 {
        margin-top: 0;
        color: #333;
        font-size: 1.4rem;
        margin-bottom: 15px;
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-group label {
        font-weight: 600;
        margin-bottom: 8px;
        display: block;
        color: #4a5568;
        font-size: 1rem;
    }

    .form-control {
        width: 100%;
        padding: 15px;
        border: 1px solid #cbd5e0;
        border-radius: 8px;
        font-size: 1rem;
        font-family: 'Inter', sans-serif;
        background-color: #fff;
        transition: border-color 0.2s, box-shadow 0.2s;
        box-sizing: border-box;
        line-height: 1.6;
    }

    .form-control:focus {
        border-color: #0061f2;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 97, 242, 0.1);
    }

    form .btn-primary {
        background: #0061f2;
        border: none;
        padding: 15px 30px;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s, transform 0.1s;
        width: 100%;
        display: block;
    }

    form .btn-primary:hover {
        background: #0050d1;
    }

    form .btn-primary:active {
        transform: translateY(1px);
    }

    /* Autocomplete Styles */
    .medicine-wrapper {
        position: relative;
    }

    .suggestions-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #cbd5e0;
        border-radius: 0 0 8px 8px;
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .suggestions-list li {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f1f1f1;
        transition: background 0.2s;
    }

    .suggestions-list li:hover,
    .suggestions-list li.active {
        background-color: #f8f9fa;
        color: #0061f2;
    }

    .suggestions-list li strong {
        display: block;
        font-size: 0.95rem;
    }

    .suggestions-list li small {
        color: #7f8c8d;
        font-size: 0.8rem;
    }
</style>
{% endblock %}